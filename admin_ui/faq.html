<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FAQç·¨é›† - ACS FAQ Manager</title>
  <style>
    :root {
      --brand: #0066cc; --brand-dark: #004fa3; --brand-light: #e8f0fb;
      --bg: #f6f7fb; --white: #fff; --text: #111827; --text-muted: #6b7280;
      --border: #e5e7eb; --danger: #ef4444; --success: #10b981;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Meiryo", sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
      display: flex; flex-direction: column; font-size: 14px;
    }
    header {
      background: #001529; color: #fff; padding: 0 24px;
      display: flex; justify-content: space-between; align-items: center;
      height: 56px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); gap: 12px;
    }
    .header-left { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .header-title { font-size: 16px; font-weight: 700; }
    nav { display: flex; gap: 4px; overflow-x: auto; }
    nav a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 7px 12px; border-radius: 6px; font-size: 13px; white-space: nowrap; transition: all 0.2s; }
    nav a:hover, nav a.active { background: rgba(255,255,255,0.12); color: #fff; }
    .btn-logout { background: none; border: none; color: rgba(255,255,255,0.8); cursor: pointer; padding: 7px 12px; font-size: 13px; border-radius: 6px; font-family: inherit; white-space: nowrap; }
    .btn-logout:hover { background: rgba(255,255,255,0.1); color: #fff; }

    main { flex: 1; max-width: 1200px; margin: 0 auto; width: 100%; padding: 24px; }

    .toolbar {
      display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
    }
    .toolbar-title { font-size: 20px; font-weight: 700; flex: 1; }
    .search-box {
      padding: 8px 14px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 13px; font-family: inherit; outline: none; min-width: 200px;
    }
    .search-box:focus { border-color: var(--brand); }
    .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn-primary:hover { background: var(--brand-dark); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { opacity: 0.85; }
    .btn-outline { background: #fff; border: 1.5px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--brand); color: var(--brand); }

    .card { background: var(--white); border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); overflow: hidden; }

    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--bg); }
    th { padding: 11px 14px; text-align: left; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; border-bottom: 1px solid var(--border); }
    td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: top; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f9fafb; }

    .badge { display: inline-block; padding: 2px 9px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .badge-brand { background: var(--brand-light); color: var(--brand); }

    .action-btns { display: flex; gap: 6px; }
    .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 6px; }

    .loading { text-align: center; padding: 40px; color: var(--text-muted); }
    .spinner { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--brand); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
      display: none; align-items: flex-start; justify-content: center;
      padding: 40px 16px; overflow-y: auto; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: #fff; border-radius: 12px; width: 100%; max-width: 600px;
      margin: auto; box-shadow: var(--shadow-md); animation: modalIn 0.2s ease;
    }
    @keyframes modalIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 17px; font-weight: 700; }
    .modal-close { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--text-muted); padding: 4px 8px; border-radius: 6px; }
    .modal-close:hover { background: var(--bg); }
    .modal-body { padding: 20px 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .form-input, .form-textarea, .form-select {
      width: 100%; padding: 9px 12px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 13px; font-family: inherit; outline: none; transition: border-color 0.2s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--brand); }
    .form-textarea { resize: vertical; min-height: 100px; }
    .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
      background: var(--text); color: #fff; border-radius: 8px; font-size: 13px;
      z-index: 9999; opacity: 0; transform: translateY(8px); transition: all 0.3s;
      max-width: 300px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    footer { background: var(--white); border-top: 1px solid var(--border); padding: 16px 24px; text-align: center; color: var(--text-muted); font-size: 12px; }

    @media (max-width: 600px) {
      header { padding: 0 12px; }
      .header-title { display: none; }
      main { padding: 16px 12px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      th:nth-child(3), td:nth-child(3) { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <span style="font-size:20px;">ğŸ¢</span>
      <span class="header-title">ACS FAQ Manager</span>
    </div>
    <nav>
      <a href="/admin/dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
      <a href="/admin/videos">å‹•ç”»ãƒ‡ãƒ¼ã‚¿</a>
      <a href="/admin/synonyms">åŒç¾©èª</a>
      <a href="/admin/faq" class="active">FAQç·¨é›†</a>
      <a href="/admin/logs">ãƒ­ã‚°é–²è¦§</a>
    </nav>
    <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <main>
    <div class="toolbar">
      <div class="toolbar-title">ğŸ“ FAQç·¨é›†</div>
      <input type="search" id="searchBox" class="search-box" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿..." oninput="filterFaq()" />
      <button class="btn btn-primary" onclick="openCreateModal()">ï¼‹ æ–°è¦ä½œæˆ</button>
    </div>

    <div class="card">
      <div id="loadingArea" class="loading"><div class="spinner"></div></div>
      <table id="faqTable" style="display:none;">
        <thead>
          <tr>
            <th>ID</th>
            <th>ã‚«ãƒ†ã‚´ãƒª</th>
            <th>è³ªå•</th>
            <th style="width:140px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="faqTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- ç·¨é›†/ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">FAQä½œæˆ</div>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ID</label>
          <input type="text" id="fieldId" class="form-input" placeholder="FAQ-0001" />
          <div class="form-hint">æ–°è¦ä½œæˆæ™‚ã®ã¿è¨­å®šå¯èƒ½</div>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
          <input type="text" id="fieldCategory" class="form-input" placeholder="èµ·å‹•ãƒ»ç”»é¢" />
        </div>
        <div class="form-group">
          <label class="form-label">è³ªå•</label>
          <input type="text" id="fieldQuestion" class="form-input" placeholder="è³ªå•å†…å®¹ã‚’å…¥åŠ›" />
        </div>
        <div class="form-group">
          <label class="form-label">æ‰‹é †ï¼ˆ1è¡Œ1ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</label>
          <textarea id="fieldSteps" class="form-textarea" placeholder="æ‰‹é †1&#10;æ‰‹é †2&#10;æ‰‹é †3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
          <input type="text" id="fieldKeywords" class="form-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveFaq()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal-box">
      <div class="modal-header">
        <div class="modal-title">å‰Šé™¤ã®ç¢ºèª</div>
        <button class="modal-close" onclick="closeDeleteModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMsg" style="font-size:14px;line-height:1.6;"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <footer>Copyright Â© 2026 Toray Advanced Computer Solution, Inc.</footer>

  <script>
    var auth = localStorage.getItem('admin_auth');
    if (!auth) { window.location.href = '/admin'; }
    var authData = JSON.parse(auth);
    var authHeader = 'Basic ' + btoa(unescape(encodeURIComponent(authData.username + ':' + authData.password)));

    var allItems = [];
    var editingId = null;
    var deletingId = null;

    function logout() { localStorage.removeItem('admin_auth'); window.location.href = '/admin'; }

    function getHeaders() {
      return { 'Authorization': authHeader, 'Content-Type': 'application/json' };
    }

    // èª­ã¿è¾¼ã¿
    function loadFaq() {
      fetch('/admin/api/faq/items?limit=1000', { headers: { 'Authorization': authHeader } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          allItems = data.items || [];
          renderTable(allItems);
          document.getElementById('loadingArea').style.display = 'none';
          document.getElementById('faqTable').style.display = '';
        })
        .catch(function() {
          document.getElementById('loadingArea').innerHTML = '<p style="color:#ef4444;padding:24px;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        });
    }

    function renderTable(items) {
      var tbody = document.getElementById('faqTbody');
      tbody.innerHTML = '';
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:32px;color:#6b7280;">FAQãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }
      items.forEach(function(item) {
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td><code style="font-size:11px;background:#f3f4f6;padding:2px 6px;border-radius:4px;">' + esc(item.id || '') + '</code></td>' +
          '<td><span class="badge badge-brand">' + esc(item.category || '') + '</span></td>' +
          '<td style="max-width:400px;">' + esc(item.question || '') + '</td>' +
          '<td><div class="action-btns">' +
            '<button class="btn btn-outline btn-sm" onclick="openEditModal(\'' + esc(item.id) + '\')">ç·¨é›†</button>' +
            '<button class="btn btn-danger btn-sm" onclick="openDeleteModal(\'' + esc(item.id) + '\',\'' + esc(item.question || '') + '\')">å‰Šé™¤</button>' +
          '</div></td>';
        tbody.appendChild(tr);
      });
    }

    function filterFaq() {
      var q = document.getElementById('searchBox').value.toLowerCase();
      if (!q) { renderTable(allItems); return; }
      var filtered = allItems.filter(function(item) {
        return (item.question || '').toLowerCase().indexOf(q) !== -1 ||
               (item.category || '').toLowerCase().indexOf(q) !== -1 ||
               (item.id || '').toLowerCase().indexOf(q) !== -1;
      });
      renderTable(filtered);
    }

    // ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
    function openCreateModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'FAQæ–°è¦ä½œæˆ';
      document.getElementById('fieldId').value = '';
      document.getElementById('fieldId').disabled = false;
      document.getElementById('fieldCategory').value = '';
      document.getElementById('fieldQuestion').value = '';
      document.getElementById('fieldSteps').value = '';
      document.getElementById('fieldKeywords').value = '';
      document.getElementById('editModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function openEditModal(id) {
      var item = allItems.find(function(i) { return i.id === id; });
      if (!item) return;
      editingId = id;
      document.getElementById('modalTitle').textContent = 'FAQç·¨é›†';
      document.getElementById('fieldId').value = item.id || '';
      document.getElementById('fieldId').disabled = true;
      document.getElementById('fieldCategory').value = item.category || '';
      document.getElementById('fieldQuestion').value = item.question || '';
      document.getElementById('fieldSteps').value = (item.steps || []).join('\n');
      document.getElementById('fieldKeywords').value = (item.keywords || []).join(', ');
      document.getElementById('editModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('editModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function saveFaq() {
      var id = document.getElementById('fieldId').value.trim();
      var category = document.getElementById('fieldCategory').value.trim();
      var question = document.getElementById('fieldQuestion').value.trim();
      var stepsRaw = document.getElementById('fieldSteps').value;
      var steps = stepsRaw.split('\n').map(function(s) { return s.trim(); }).filter(Boolean);
      var kwRaw = document.getElementById('fieldKeywords').value;
      var keywords = kwRaw.split(',').map(function(k) { return k.trim(); }).filter(Boolean);

      if (!id || !question) { showToast('IDã¨è³ªå•ã¯å¿…é ˆã§ã™', 'error'); return; }

      var itemData = { id: id, category: category, question: question, steps: steps, keywords: keywords, utterances: [question] };

      var url, method;
      if (editingId) {
        url = '/admin/api/faq/item/' + encodeURIComponent(editingId);
        method = 'PATCH';
      } else {
        url = '/admin/api/faq/item';
        method = 'POST';
      }

      document.getElementById('saveBtn').textContent = 'ä¿å­˜ä¸­...';
      document.getElementById('saveBtn').disabled = true;

      fetch(url, {
        method: method,
        headers: getHeaders(),
        body: JSON.stringify(itemData)
      })
      .then(function(r) {
        if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'ã‚¨ãƒ©ãƒ¼'); });
        return r.json();
      })
      .then(function() {
        closeModal();
        showToast(editingId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'ä½œæˆã—ã¾ã—ãŸ', 'success');
        loadFaq();
      })
      .catch(function(e) {
        showToast('ä¿å­˜å¤±æ•—: ' + e.message, 'error');
      })
      .finally(function() {
        document.getElementById('saveBtn').textContent = 'ä¿å­˜';
        document.getElementById('saveBtn').disabled = false;
      });
    }

    function openDeleteModal(id, question) {
      deletingId = id;
      document.getElementById('deleteConfirmMsg').textContent = 'ã€Œ' + question + 'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚';
      document.getElementById('deleteModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function confirmDelete() {
      if (!deletingId) return;
      fetch('/admin/api/faq/item/' + encodeURIComponent(deletingId), {
        method: 'DELETE',
        headers: { 'Authorization': authHeader }
      })
      .then(function(r) {
        if (!r.ok) throw new Error('å‰Šé™¤å¤±æ•—');
        closeDeleteModal();
        showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        loadFaq();
      })
      .catch(function() { showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); });
    }

    function showToast(msg, type) {
      var el = document.getElementById('toast');
      el.textContent = msg;
      el.className = 'toast show' + (type ? ' ' + type : '');
      setTimeout(function() { el.className = 'toast'; }, 3000);
    }

    function esc(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    document.getElementById('deleteModal').addEventListener('click', function(e) { if (e.target === this) closeDeleteModal(); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeModal(); closeDeleteModal(); } });

    loadFaq();
  </script>
</body>
</html>
