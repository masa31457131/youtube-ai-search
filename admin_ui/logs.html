<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理画面 - 検索ログ</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, sans-serif; margin:0; background:#f6f7fb;}
    header{background:#111827; color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center;}
    main{max-width:1100px; margin:0 auto; padding:18px;}
    .card{background:#fff; border-radius:10px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:14px;}
    select, button{font:inherit;}
    .btn{border:0; border-radius:8px; padding:10px 12px; cursor:pointer; font-weight:600;}
    .btn.primary{background:#2563eb; color:#fff;}
    .btn.gray{background:#e5e7eb;}
    table{width:100%; border-collapse:collapse;}
    th,td{border-bottom:1px solid #e5e7eb; padding:8px; text-align:left;}
    .muted{color:#6b7280; font-size:.9rem;}
  </style>
</head>
<body>
<header>
  <div>管理画面 - 検索ログ（月別 / 日別）</div>
  <div>
    <a href="/admin" style="color:#fff; margin-right:14px;">データ編集へ</a>
    <a href="/admin/faq" style="color:#fff; margin-right:14px;">FAQフォーム編集</a>
    <button class="btn gray" id="logoutBtn">ログアウト</button>
  </div>
</header>

<main>
  <div class="card">
    <h3>対象月を選択</h3>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <select id="monthSel"></select>
      <button class="btn primary" id="loadBtn">表示</button>
      <button class="btn gray" id="csvBtn">CSVダウンロード</button>
    </div>
    <div class="muted" id="status"></div>
  </div>

  <div class="card">
    <h3>日別検索回数</h3>
    <table>
      <thead><tr><th>日付</th><th>回数</th></tr></thead>
      <tbody id="daysBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>上位クエリ（最大50件）</h3>
    <table>
      <thead><tr><th>クエリ</th><th>回数</th></tr></thead>
      <tbody id="qBody"></tbody>
    </table>
  </div>
</main>

<script>
  const storeKey = "adminBasicAuth";

  function getAuth(){ return localStorage.getItem(storeKey); }
  function clearAuth(){ localStorage.removeItem(storeKey); }

  async function api(path, opts={}){
    const token = getAuth();
    if(!token) throw new Error("未ログインです");
    const headers = Object.assign({}, opts.headers||{}, {"Authorization":`Basic ${token}`});
    return fetch(path, {...opts, headers});
  }

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    clearAuth(); location.href="/admin";
  });

  async function loadMonths(){
    const r = await api("/admin/api/logs/months");
    if(!r.ok) throw new Error("認証エラー");
    const j = await r.json();
    const sel = document.getElementById("monthSel");
    sel.innerHTML = "";
    (j.months || []).forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m; opt.textContent = m;
      sel.appendChild(opt);
    });
  }

  async function loadSummary(){
    const month = document.getElementById("monthSel").value;
    const st = document.getElementById("status");
    st.textContent = "読み込み中...";
    const r = await api(`/admin/api/logs/summary?month=${encodeURIComponent(month)}`);
    const j = await r.json();
    if(!r.ok){ st.textContent = "失敗: " + (j.detail||""); return; }

    const daysBody = document.getElementById("daysBody");
    daysBody.innerHTML = "";
    (j.days || []).forEach(d=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${d.day}</td><td>${d.count}</td>`;
      daysBody.appendChild(tr);
    });

    const qBody = document.getElementById("qBody");
    qBody.innerHTML = "";
    (j.top_queries || []).forEach(q=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(q.query)}</td><td>${q.count}</td>`;
      qBody.appendChild(tr);
    });

    st.textContent = `表示中: ${j.month}`;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  document.getElementById("loadBtn").addEventListener("click", loadSummary);
  document.getElementById("csvBtn").addEventListener("click", async ()=>{
    const r = await api("/admin/api/logs/export");
    if(!r.ok){ alert("ダウンロード失敗"); return; }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "search_logs.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  (async ()=>{
    try{
      await loadMonths();
      await loadSummary();
    }catch(e){
      location.href="/admin";
    }
  })();
</script>
</body>
</html>
