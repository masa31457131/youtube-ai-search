<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サポート検索（動画 + FAQ）</title>
  <style>
    body {
      font-family: "Meiryo", "Yu Gothic", sans-serif;
      margin: 0;
      background: #fff;
      color: #333;
    }
    header {
      background: #005BAC;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    main {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    #searchInput {
      width: 100%;
      max-width: 620px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .section-title{
      margin: 1.2rem 0 0.6rem;
      font-size: 1.05rem;
      font-weight: 700;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .badge{
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: #e8f1fb;
      color: #005BAC;
      border: 1px solid #cfe3fb;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.2rem;
    }

    .card {
      border: 1px solid #e1e1e1;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .card-body {
      padding: 1rem;
    }

    .muted {
      color: #666;
      font-size: 0.85rem;
    }

    /* FAQ */
    .faq-item summary{
      cursor: pointer;
      padding: 0.9rem 1rem;
      font-weight: 700;
      list-style: none;
    }
    .faq-item summary::-webkit-details-marker{ display:none; }
    .faq-meta{
      padding: 0 1rem 0.6rem;
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
    }
    .pill{
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      color: #444;
    }
    .steps{
      padding: 0 1.2rem 1rem;
      margin: 0;
    }
    .steps li{
      margin: 0.35rem 0;
      line-height: 1.5;
    }

    /* Video cards */
    .video-card img { width: 100%; }
    .video-card a {
      font-weight: 700;
      color: #005BAC;
      font-size: 1rem;
      text-decoration: none;
    }
    .video-card a:hover { text-decoration: underline; }

    .empty {
      border: 1px dashed #ddd;
      border-radius: 10px;
      padding: 1rem;
      background: #fcfcfc;
      color: #666;
    }
  
    .pager{
      display:flex;
      gap:0.5rem;
      align-items:center;
      margin: 0.75rem 0;
      flex-wrap: wrap;
    }
    .pager button{
      padding: 0.35rem 0.7rem;
      border-radius: 6px;
      border: 1px solid #cfe3fb;
      background: #e8f1fb;
      color: #005BAC;
      cursor: pointer;
      font-weight: 600;
    }
    .pager button:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

</style>
</head>
<body>
  <header>
    <h1>サポート検索（動画 + FAQ）</h1>
  </header>

  <main>
    <input type="text" id="searchInput" placeholder="キーワードを入力して検索…" />

    <div class="section-title">FAQ候補 <span class="badge" id="faqCount">0</span>
    <div class="pager">
      <button id="faqPrev" disabled>前の10件</button>
      <button id="faqNext" disabled>次の10件</button>
      <span id="faqPageInfo" class="muted"></span>
    </div>
</div>
    <div id="faqResults" class="grid"></div>

    <div class="section-title">関連動画 <span class="badge" id="videoCount">0</span>
    <div class="pager">
      <button id="videoPrev" disabled>前の10件</button>
      <button id="videoNext" disabled>次の10件</button>
      <span id="videoPageInfo" class="muted"></span>
    </div>
</div>
    <div id="videoResults" class="grid"></div>
  </main>

  <script>

    const PAGE_SIZE = 10;

    const $ = (id) => document.getElementById(id);
    const esc = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

    let timer = null;

    // ページ状態（offset方式）
    let faqOffset = 0;
    let videoOffset = 0;
    let lastQuery = "";

    function setPager(kind, hasMore, offset, countOnPage){
      const isFaq = kind === "faq";
      const prevBtn = $(isFaq ? "faqPrev" : "videoPrev");
      const nextBtn = $(isFaq ? "faqNext" : "videoNext");
      const info = $(isFaq ? "faqPageInfo" : "videoPageInfo");

      prevBtn.disabled = offset <= 0;
      nextBtn.disabled = !hasMore;

      if(countOnPage === 0){
        info.textContent = "";
        return;
      }
      const start = offset + 1;
      const end = offset + countOnPage;
      info.textContent = `${start}-${end}${hasMore ? "" : ""}`;
    }

    async function fetchPaged(url){
      const r = await fetch(url);
      if(!r.ok){
        return { items: [], has_more: false, offset: 0, limit: PAGE_SIZE };
      }
      // paged=1 を付けると {items, has_more, offset, limit} で返る
      return r.json();
    }

    function renderFaq(items, meta){
      const root = $("faqResults");
      root.innerHTML = "";
      $("faqCount").textContent = String(meta.total_visible ?? (items?.length || 0));

      if(!items || items.length === 0){
        root.innerHTML = `<p class="muted">FAQの該当結果はありません。</p>`;
        setPager("faq", false, faqOffset, 0);
        return;
      }

      for(const f of items){
        const card = document.createElement("div");
        card.className = "card";
        const steps = Array.isArray(f.steps) ? f.steps : [];
        const stepsHtml = steps.length
          ? `<ol>${steps.map(s => `<li>${esc(s)}</li>`).join("")}</ol>`
          : `<p class="muted">（手順がありません）</p>`;

        const metaLine = [
          f.category ? `カテゴリ: ${esc(f.category)}` : "",
          (Array.isArray(f.keywords) && f.keywords.length) ? `KW: ${esc(f.keywords.join(", "))}` : ""
        ].filter(Boolean).join(" / ");

        card.innerHTML = `
          <div>
            <div style="display:flex; justify-content:space-between; gap:12px;">
              <strong>${esc(f.question || "")}</strong>
              <span class="badge">${esc(f.id || "")}</span>
            </div>
            ${metaLine ? `<div class="muted" style="margin:6px 0 8px 0;">${metaLine}</div>` : ""}
            ${stepsHtml}
          </div>
        `;
        root.appendChild(card);
      }

      setPager("faq", !!meta.has_more, faqOffset, items.length);
    }

    function renderVideos(items, meta){
      const root = $("videoResults");
      root.innerHTML = "";
      $("videoCount").textContent = String(meta.total_visible ?? (items?.length || 0));

      if(!items || items.length === 0){
        root.innerHTML = `<p class="muted">動画の該当結果はありません。</p>`;
        setPager("video", false, videoOffset, 0);
        return;
      }

      for(const v of items){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display:flex; gap:12px;">
            ${v.thumbnail ? `<img src="${esc(v.thumbnail)}" alt="thumbnail" style="width:160px; height:90px; object-fit:cover; border-radius:8px;">` : ""}
            <div style="flex:1;">
              <a href="${esc(v.url || "#")}" target="_blank" rel="noreferrer noopener" style="font-weight:700; color:#005BAC; text-decoration:none;">
                ${esc(v.title || "")}
              </a>
              <div class="muted" style="margin-top:6px;">${esc(v.description || "")}</div>
            </div>
          </div>
        `;
        root.appendChild(card);
      }

      setPager("video", !!meta.has_more, videoOffset, items.length);
    }

    async function loadFaqPage(){
      if(!lastQuery){
        renderFaq([], {has_more:false, total_visible:0});
        return;
      }
      const url = `/faq/search?query=${encodeURIComponent(lastQuery)}&offset=${faqOffset}&limit=${PAGE_SIZE}&paged=1`;
      const data = await fetchPaged(url);
      renderFaq(data.items || [], {has_more: data.has_more, total_visible: data.total_visible});
    }

    async function loadVideoPage(){
      if(!lastQuery){
        renderVideos([], {has_more:false, total_visible:0});
        return;
      }
      const url = `/search?query=${encodeURIComponent(lastQuery)}&offset=${videoOffset}&limit=${PAGE_SIZE}&paged=1`;
      const data = await fetchPaged(url);
      renderVideos(data.items || [], {has_more: data.has_more, total_visible: data.total_visible});
    }

    async function doSearch(query){
      lastQuery = query;
      faqOffset = 0;
      videoOffset = 0;

      if (!query || query.length < 1) {
        $("faqResults").innerHTML = "";
        $("videoResults").innerHTML = "";
        $("faqCount").textContent = "0";
        $("videoCount").textContent = "0";
        setPager("faq", false, 0, 0);
        setPager("video", false, 0, 0);
        return;
      }

      // FAQ候補と動画検索を並列に実行（片方が失敗しても表示は継続）
      await Promise.allSettled([loadFaqPage(), loadVideoPage()]);
    }

    $("faqPrev").addEventListener("click", async () => { faqOffset = Math.max(0, faqOffset - PAGE_SIZE); await loadFaqPage(); });
    $("faqNext").addEventListener("click", async () => { faqOffset = faqOffset + PAGE_SIZE; await loadFaqPage(); });
    $("videoPrev").addEventListener("click", async () => { videoOffset = Math.max(0, videoOffset - PAGE_SIZE); await loadVideoPage(); });
    $("videoNext").addEventListener("click", async () => { videoOffset = videoOffset + PAGE_SIZE; await loadVideoPage(); });

    $("searchInput").addEventListener("input", () => {
      const q = $("searchInput").value.trim();
      clearTimeout(timer);
      timer = setTimeout(() => doSearch(q), 250);
    });

    // 初期状態
    setPager("faq", false, 0, 0);
    setPager("video", false, 0, 0);

  </script>
</body>
</html>
