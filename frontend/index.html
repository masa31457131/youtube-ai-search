<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚µãƒãƒ¼ãƒˆæ¤œç´¢ | æ±ãƒ¬ACS</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Meiryo", "Yu Gothic", sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    header {
      background: #fff;
      border-bottom: 3px solid #0066cc;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header h1 { font-size: 1.75rem; font-weight: 700; color: #0066cc; margin-bottom: 0.25rem; }
    header p { font-size: 0.9rem; color: #666; }
    main { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .search-wrap { max-width: 700px; margin: 0 auto 3rem; }
    #searchInput {
      width: 100%;
      padding: 1rem 1.25rem;
      font-size: 1.1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      outline: none;
      transition: border-color 0.2s;
    }
    #searchInput:focus { border-color: #0066cc; }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .section-header {
      display: flex; align-items: center; justify-content: space-between;
      margin: 2.5rem 0 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #0066cc;
    }
    .section-title { font-size: 1.2rem; font-weight: 700; color: #0066cc; }
    .badge {
      font-size: 0.8rem; font-weight: 600;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      background: #e3f2fd; color: #0066cc;
      border: 1px solid #0066cc;
    }

    /* FAQã‚°ãƒªãƒƒãƒ‰ï¼šã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ */
    .faq-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .faq-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .faq-card:hover { border-color: #0066cc; box-shadow: 0 4px 12px rgba(0,102,204,0.15); transform: translateY(-1px); }
    .faq-card-icon { font-size: 1.2rem; flex-shrink: 0; color: #0066cc; }
    .faq-card-title { font-size: 0.95rem; font-weight: 600; color: #0066cc; line-height: 1.4; }

    /* å‹•ç”»ã‚°ãƒªãƒƒãƒ‰ï¼šã‚µãƒ ãƒã‚¤ãƒ«ã®ã¿ */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .video-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      aspect-ratio: 16 / 9;
      position: relative;
    }
    .video-card:hover { border-color: #0066cc; box-shadow: 0 4px 12px rgba(0,102,204,0.15); transform: translateY(-2px); }
    .video-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .video-card-overlay {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex; align-items: center; justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .video-card:hover .video-card-overlay { opacity: 1; }
    .play-icon { font-size: 2.5rem; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    .video-no-thumb {
      width: 100%; height: 100%;
      background: #ddd;
      display: flex; align-items: center; justify-content: center;
      color: #999; font-size: 0.9rem;
    }

    /* ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ */
    .pager { display: flex; gap: 1rem; align-items: center; justify-content: center; margin: 1.5rem 0; }
    .pager button {
      padding: 0.5rem 1.2rem; border: 1px solid #ddd;
      background: #fff; border-radius: 6px; cursor: pointer;
      font-size: 0.9rem; color: #333; transition: all 0.2s;
    }
    .pager button:hover:not([disabled]) { background: #0066cc; color: #fff; border-color: #0066cc; }
    .pager button[disabled] { opacity: 0.4; cursor: not-allowed; }
    .pager-info { color: #999; font-size: 0.9rem; }

    /* çŠ¶æ…‹è¡¨ç¤º */
    .empty-state { text-align: center; padding: 4rem 2rem; }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-title { color: #666; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .empty-sub { color: #999; font-size: 0.9rem; }
    .loading { text-align: center; padding: 4rem 2rem; }
    .spinner {
      width: 48px; height: 48px; margin: 0 auto 1rem;
      border: 4px solid #f0f0f0;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ */
    .lightbox {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.82);
      align-items: center; justify-content: center;
    }
    .lightbox.open { display: flex; }
    .lb-box {
      background: #fff;
      border-radius: 12px;
      width: 90%; max-width: 820px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .lb-close {
      position: absolute; top: 1rem; right: 1.25rem;
      font-size: 2rem; cursor: pointer; color: #aaa;
      line-height: 1; border: none; background: none;
      transition: color 0.2s;
    }
    .lb-close:hover { color: #333; }
    .lb-title {
      font-size: 1.35rem; font-weight: 700; color: #0066cc;
      padding-right: 2.5rem; margin-bottom: 1.25rem;
      border-bottom: 1px solid #eee; padding-bottom: 1rem;
    }
    .lb-body { line-height: 1.85; color: #333; }
    .lb-answer { white-space: pre-wrap; font-size: 0.98rem; }
    .lb-video-wrap { position: relative; padding-top: 56.25%; margin-bottom: 1.25rem; }
    .lb-video-wrap iframe {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      border: none; border-radius: 8px;
    }
    .lb-desc { color: #555; font-size: 0.9rem; white-space: pre-wrap; border-top: 1px solid #eee; padding-top: 1rem; margin-top: 0.5rem; }
  </style>
</head>
<body>
<header>
  <h1>ğŸ¢ æ±ãƒ¬ACS ã‚µãƒãƒ¼ãƒˆæ¤œç´¢</h1>
  <p>FAQãƒ»ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»å‹•ç”»ã‹ã‚‰ã€ãŠæ¢ã—ã®æƒ…å ±ã‚’æ¤œç´¢ã§ãã¾ã™</p>
</header>
<main>
  <div class="search-wrap">
    <input type="text" id="searchInput" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" autocomplete="off" />
  </div>
  <div id="resultsContainer"></div>
</main>

<!-- ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ -->
<div id="lightbox" class="lightbox">
  <div class="lb-box">
    <button class="lb-close" onclick="closeLb()" aria-label="é–‰ã˜ã‚‹">&times;</button>
    <div id="lbTitle" class="lb-title"></div>
    <div id="lbBody" class="lb-body"></div>
  </div>
</div>

<script>
  /* =============================================
     è¨­å®š
  ============================================= */
  var PAGE_SIZE  = 20;
  var DEBOUNCE   = 300;

  /* =============================================
     çŠ¶æ…‹
  ============================================= */
  var lastQuery   = "";
  var faqOffset   = 0;
  var videoOffset = 0;
  var faqHasMore  = false;
  var vidHasMore  = false;
  var faqItems    = [];
  var vidItems    = [];
  var synonyms    = {};
  var timer       = null;

  /* =============================================
     ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  ============================================= */
  function $(id){ return document.getElementById(id); }

  function esc(s){
    var d = document.createElement("div");
    d.textContent = s || "";
    return d.innerHTML;
  }

  // URLã‹ã‚‰YouTube video_idã‚’æŠ½å‡º
  function extractVideoId(item){
    if(item.video_id && item.video_id.trim()) return item.video_id.trim();
    var url = item.url || "";
    var m = url.match(/[?&]v=([^&]+)/);
    if(m) return m[1];
    m = url.match(/youtu\.be\/([^?&]+)/);
    if(m) return m[1];
    return "";
  }

  // FAQã®è³ªå•æ–‡ã‚’å–å¾—ï¼ˆè¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¯¾å¿œï¼‰
  function getFaqQuestion(item){
    if(item.questions && item.questions.length) return item.questions[0];
    if(item.utterances && item.utterances.length) return item.utterances[0];
    if(item.question) return item.question;
    if(item.intent)   return item.intent;
    return "ï¼ˆè³ªå•ãªã—ï¼‰";
  }

  // FAQã®å›ç­”æ–‡ã‚’å–å¾—ï¼ˆè¤‡æ•°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¯¾å¿œï¼‰
  function getFaqAnswer(item){
    if(item.answer)    return item.answer;
    if(item.response)  return item.response;
    if(item.content)   return item.content;
    return "";
  }

  /* =============================================
     Synonyms
  ============================================= */
  function loadSynonyms(){
    fetch("/api/synonyms")
      .then(function(r){ return r.ok ? r.json() : {}; })
      .then(function(d){ synonyms = d; })
      .catch(function(){});
  }

  function expandQuery(q){
    var words = q.toLowerCase().split(/\s+/);
    var set = {};
    for(var i=0;i<words.length;i++) set[words[i]]=1;

    for(var i=0;i<words.length;i++){
      var w = words[i];
      for(var key in synonyms){
        var vars = synonyms[key];
        if(!Array.isArray(vars)) continue;
        var inVars = false;
        for(var j=0;j<vars.length;j++){
          if(vars[j].toLowerCase()===w){ inVars=true; break; }
        }
        if(inVars){
          set[key]=1;
          for(var j=0;j<vars.length;j++) set[vars[j]]=1;
        } else if(key.toLowerCase()===w){
          for(var j=0;j<vars.length;j++) set[vars[j]]=1;
        }
      }
    }

    var arr=[];
    for(var k in set) arr.push(k);
    return arr.join(" ");
  }

  /* =============================================
     ãƒ­ã‚°
  ============================================= */
  function sendLog(type, id){
    fetch("/api/log_search",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query:lastQuery, result_type:type, result_id:id, timestamp:new Date().toISOString()})
    }).catch(function(){});
  }

  /* =============================================
     API
  ============================================= */
  function apiFetch(path){
    return fetch(path).then(function(r){
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    });
  }

  function loadFAQ(){
    var q = expandQuery(lastQuery);
    var p = new URLSearchParams({query:q, offset:faqOffset, limit:PAGE_SIZE, paged:1});
    return apiFetch("/faq/search?" + p);
  }

  function loadVideos(){
    var q = expandQuery(lastQuery);
    var p = new URLSearchParams({query:q, offset:videoOffset, limit:PAGE_SIZE, paged:1});
    return apiFetch("/search?" + p);
  }

  /* =============================================
     æç”»
  ============================================= */
  function renderFAQ(items){
    if(!items || !items.length)
      return '<p style="color:#999;padding:1rem 0;">FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';

    var html = '<div class="faq-grid">';
    for(var i=0;i<items.length;i++){
      var q = esc(getFaqQuestion(items[i]));
      html += '<div class="faq-card" data-type="faq" data-index="' + i + '">'
            + '<span class="faq-card-icon">Q</span>'
            + '<span class="faq-card-title">' + q + '</span>'
            + '</div>';
    }
    html += '</div>';
    return html;
  }

  function renderVideos(items){
    if(!items || !items.length)
      return '<p style="color:#999;padding:1rem 0;">å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';

    var html = '<div class="video-grid">';
    for(var i=0;i<items.length;i++){
      var v    = items[i];
      var vid  = extractVideoId(v);
      var thumb = v.thumbnail || "";
      var title = esc(v.title || "");

      html += '<div class="video-card" data-type="video" data-index="' + i + '" title="' + title + '">';
      if(thumb){
        html += '<img src="' + esc(thumb) + '" alt="' + title + '" loading="lazy">';
      } else {
        html += '<div class="video-no-thumb">å‹•ç”»</div>';
      }
      html += '<div class="video-card-overlay"><span class="play-icon">â–¶</span></div>';
      html += '</div>';
    }
    html += '</div>';
    return html;
  }

  function renderPager(type, hasMore, offset, count){
    var prev = type==="faq" ? "faqPrev" : "vidPrev";
    var next = type==="faq" ? "faqNext" : "vidNext";
    var pd   = offset<=0 ? "disabled" : "";
    var nd   = !hasMore   ? "disabled" : "";
    var info = count>0 ? (offset+1) + "â€“" + (offset+count) + "ä»¶" : "";
    return '<div class="pager">'
          + '<button id="'+prev+'" '+pd+'>â† å‰</button>'
          + '<button id="'+next+'" '+nd+'>æ¬¡ â†’</button>'
          + '<span class="pager-info">'+info+'</span>'
          + '</div>';
  }

  /* =============================================
     æ¤œç´¢å®Ÿè¡Œ
  ============================================= */
  function renderResults(){
    var c = $("resultsContainer");
    if(!lastQuery.trim()){
      c.innerHTML = '<div class="empty-state">'
                  + '<div class="empty-icon">ğŸ”</div>'
                  + '<div class="empty-title">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢</div>'
                  + '<div class="empty-sub">å‹•ç”»ã¨FAQã‹ã‚‰æœ€é©ãªæƒ…å ±ã‚’è¦‹ã¤ã‘ã¾ã™</div>'
                  + '</div>';
      return;
    }

    c.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ¤œç´¢ä¸­...</p></div>';

    Promise.all([loadFAQ(), loadVideos()])
      .then(function(res){
        var fd = res[0]; var vd = res[1];
        faqHasMore  = fd.has_more  || false;
        vidHasMore  = vd.has_more  || false;
        faqItems    = fd.items     || [];
        vidItems    = vd.items     || [];

        var html = "";

        // FAQ
        html += '<div class="section-header">'
              + '<span class="section-title">FAQå€™è£œ</span>'
              + '<span class="badge">' + (fd.total_visible||0) + 'ä»¶</span>'
              + '</div>';
        html += renderFAQ(faqItems);
        html += renderPager("faq", faqHasMore, faqOffset, faqItems.length);

        // å‹•ç”»
        html += '<div class="section-header">'
              + '<span class="section-title">é–¢é€£å‹•ç”»</span>'
              + '<span class="badge">' + (vd.total_visible||0) + 'ä»¶</span>'
              + '</div>';
        html += renderVideos(vidItems);
        html += renderPager("video", vidHasMore, videoOffset, vidItems.length);

        c.innerHTML = html;
        bindCards();
        bindPager();
      })
      .catch(function(e){
        c.innerHTML = '<div class="empty-state"><div class="empty-sub">æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + esc(e.message) + '</div></div>';
      });
  }

  /* =============================================
     ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
  ============================================= */
  function bindCards(){
    var cards = document.querySelectorAll("[data-type]");
    for(var i=0;i<cards.length;i++){
      (function(card){
        card.addEventListener("click", function(){
          var type  = card.dataset.type;
          var index = parseInt(card.dataset.index, 10);
          if(type==="faq"){
            var item = faqItems[index];
            if(item) openFaqLb(item);
          } else if(type==="video"){
            var item = vidItems[index];
            if(item) openVideoLb(item);
          }
        });
      })(cards[i]);
    }
  }

  /* =============================================
     ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆFAQï¼‰
  ============================================= */
  function openFaqLb(item){
    var q = getFaqQuestion(item);
    var a = getFaqAnswer(item);

    sendLog("faq", item.id || item.intent || "");

    $("lbTitle").textContent = q;

    // å›ç­”ãŒç©ºã®å ´åˆ
    if(!a || !a.trim()){
      $("lbBody").innerHTML = '<p style="color:#999;">å›ç­”ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
    } else {
      $("lbBody").innerHTML = '<div class="lb-answer">' + esc(a) + '</div>';
    }

    openLb();
  }

  /* =============================================
     ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆå‹•ç”»ï¼‰
  ============================================= */
  function openVideoLb(item){
    var vid   = extractVideoId(item);
    var title = item.title || "";
    var desc  = item.description || "";

    sendLog("video", vid || item.video_id || "");

    $("lbTitle").textContent = title;

    var body = "";

    if(vid){
      // autoplay=1, originæŒ‡å®šã§ãƒ–ãƒ­ãƒƒã‚¯å›é¿
      var embedUrl = "https://www.youtube.com/embed/" + vid
                   + "?autoplay=1&rel=0&modestbranding=1";
      body += '<div class="lb-video-wrap">'
            + '<iframe src="' + embedUrl + '"'
            + ' allow="autoplay; encrypted-media; fullscreen; picture-in-picture"'
            + ' allowfullscreen>'
            + '</iframe>'
            + '</div>';
    } else {
      body += '<p style="color:#c00;margin-bottom:1rem;">âš ï¸ å‹•ç”»IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
      if(item.url){
        body += '<p><a href="' + esc(item.url) + '" target="_blank" rel="noopener">YouTubeã§é–‹ã â†’</a></p>';
      }
    }

    if(desc.trim()){
      body += '<div class="lb-desc">' + esc(desc) + '</div>';
    }

    $("lbBody").innerHTML = body;
    openLb();
  }

  /* =============================================
     ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ é–‹é–‰
  ============================================= */
  function openLb(){
    $("lightbox").classList.add("open");
    document.body.style.overflow = "hidden";
  }

  function closeLb(){
    // iframeã‚’ç ´æ£„ã—ã¦å‹•ç”»åœæ­¢
    var iframe = $("lightbox").querySelector("iframe");
    if(iframe) iframe.src = "";

    $("lightbox").classList.remove("open");
    document.body.style.overflow = "";
    $("lbBody").innerHTML = "";
  }

  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  $("lightbox").addEventListener("click", function(e){
    if(e.target === $("lightbox")) closeLb();
  });

  // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
  document.addEventListener("keydown", function(e){
    if(e.key === "Escape") closeLb();
  });

  /* =============================================
     ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼
  ============================================= */
  function bindPager(){
    function on(id, fn){
      var el = $(id);
      if(el) el.addEventListener("click", fn);
    }
    on("faqPrev", function(){ faqOffset = Math.max(0, faqOffset-PAGE_SIZE); renderResults(); });
    on("faqNext", function(){ faqOffset += PAGE_SIZE; renderResults(); });
    on("vidPrev", function(){ videoOffset = Math.max(0, videoOffset-PAGE_SIZE); renderResults(); });
    on("vidNext", function(){ videoOffset += PAGE_SIZE; renderResults(); });
  }

  /* =============================================
     æ¤œç´¢å…¥åŠ›
  ============================================= */
  function doSearch(q){
    lastQuery   = q;
    faqOffset   = 0;
    videoOffset = 0;
    renderResults();
  }

  $("searchInput").addEventListener("input", function(e){
    clearTimeout(timer);
    var q = e.target.value;
    timer = setTimeout(function(){ doSearch(q); }, DEBOUNCE);
  });

  $("searchInput").addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      clearTimeout(timer);
      doSearch(e.target.value);
    }
  });

  /* =============================================
     åˆæœŸåŒ–
  ============================================= */
  loadSynonyms();
  renderResults();
</script>
</body>
</html>
