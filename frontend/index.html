<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>サポート検索（動画 + FAQ）</title>
  <style>
    body {
      font-family: "Meiryo", "Yu Gothic", sans-serif;
      margin: 0;
      background: #fff;
      color: #333;
    }
    header {
      background: #005BAC;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    main {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    #searchInput {
      width: 100%;
      max-width: 620px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .section-title{
      margin: 1.2rem 0 0.6rem;
      font-size: 1.05rem;
      font-weight: 700;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .badge{
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: #e8f1fb;
      color: #005BAC;
      border: 1px solid #cfe3fb;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.2rem;
    }

    .card {
      border: 1px solid #e1e1e1;
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .card-body {
      padding: 1rem;
    }

    .muted {
      color: #666;
      font-size: 0.85rem;
    }

    /* FAQ */
    .faq-item summary{
      cursor: pointer;
      padding: 0.9rem 1rem;
      font-weight: 700;
      list-style: none;
    }
    .faq-item summary::-webkit-details-marker{ display:none; }
    .faq-meta{
      padding: 0 1rem 0.6rem;
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
    }
    .pill{
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
      color: #444;
    }
    .steps{
      padding: 0 1.2rem 1rem;
      margin: 0;
    }
    .steps li{
      margin: 0.35rem 0;
      line-height: 1.5;
    }

    /* Video cards */
    .video-card img { width: 100%; }
    .video-card a {
      font-weight: 700;
      color: #005BAC;
      font-size: 1rem;
      text-decoration: none;
    }
    .video-card a:hover { text-decoration: underline; }

    .empty {
      border: 1px dashed #ddd;
      border-radius: 10px;
      padding: 1rem;
      background: #fcfcfc;
      color: #666;
    }
  

/* ===== Lightbox (Modal) ===== */
.lightbox-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.60);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 9999;
}
.lightbox-overlay.hidden{ display:none; }

.lightbox{
  width: min(980px, 96vw);
  max-height: 88vh;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 20px 80px rgba(0,0,0,.35);
  display:flex;
  flex-direction:column;
}

.lightbox-topbar{
  display:flex;
  justify-content:space-between;
  gap: 12px;
  padding: 12px 14px;
  border-bottom: 1px solid #e5e7eb;
  background: #0b1220;
  color: #fff;
  align-items:center;
}
.lightbox-title{
  font-weight: 800;
  line-height: 1.2;
}
.lightbox-actions{
  display:flex;
  gap: 8px;
  flex-wrap:wrap;
}
.lightbox-btn{
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.35);
  background: rgba(255,255,255,.08);
  color: #fff;
  cursor:pointer;
  font-weight: 700;
}
.lightbox-btn.primary{
  background:#2563eb;
  border-color:#2563eb;
}
.lightbox-body{
  padding: 14px;
  overflow:auto;
}
.lightbox-body iframe{
  width: 100%;
  aspect-ratio: 16 / 9;
  border: 0;
  border-radius: 12px;
  background: #000;
}


    .warming{
      margin: 8px 0 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      color: #92400e;
      font-weight: 700;
    }
    .hidden{ display:none; }

/* ===== Cursor: pointer on search results ===== */
.faq-title-only, .video-card { cursor: pointer; }
.faq-title-only:hover, .video-card:hover { cursor: pointer; }

</style>
</head>
<body>
  <header>
    <h1>サポート検索（動画 + FAQ）</h1>
  </header>

  <main>
    <input type="text" id="searchInput" placeholder="キーワードを入力して検索…" />

    <div class="section-title">FAQ候補 <span class="badge" id="faqCount">0</span>
    <div id="faqWarming" class="warming hidden">インデックス準備中です（warming_up中です）。しばらくして再検索してください。</div>
    <div class="pager">
      <button id="faqPrev" disabled>前の10件</button>
      <button id="faqNext" disabled>次の10件</button>
      <span id="faqPageInfo" class="muted"></span>
    </div>
</div>
    <div id="faqResults" class="grid"></div>

    <div class="section-title">関連動画 <span class="badge" id="videoCount">0</span>
    <div id="videoWarming" class="warming hidden">インデックス準備中です（warming_up中です）。しばらくして再検索してください。</div>
    <div class="pager">
      <button id="videoPrev" disabled>前の10件</button>
      <button id="videoNext" disabled>次の10件</button>
      <span id="videoPageInfo" class="muted"></span>
    </div>
</div>
    <div id="videoResults" class="grid"></div>
  </main>

  <script>
document.addEventListener("DOMContentLoaded", () => {
const PAGE_SIZE = 10;

    const $ = (id) => document.getElementById(id);
    const esc = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    let timer = null;
    let faqOffset = 0;
    let videoOffset = 0;
    let lastQuery = "";

    function setPager(kind, hasMore, offset, countOnPage){
      const isFaq = kind === "faq";
      const prevBtn = $(isFaq ? "faqPrev" : "videoPrev");
      const nextBtn = $(isFaq ? "faqNext" : "videoNext");
      const info = $(isFaq ? "faqPageInfo" : "videoPageInfo");
      if(!prevBtn || !nextBtn || !info) return;

      prevBtn.disabled = offset <= 0;
      nextBtn.disabled = !hasMore;

      if(countOnPage === 0){
        info.textContent = "";
        return;
      }
      const start = offset + 1;
      const end = offset + countOnPage;
      info.textContent = `${start}-${end}`;
    }

    
    function show(el){ if(el) el.classList.remove("hidden"); }
    function hide(el){ if(el) el.classList.add("hidden"); }

    function setWarming(kind, data){
      const el = $(kind === "faq" ? "faqWarming" : "videoWarming");
      if(!el) return;

      const isWarming = !!(data && data.warming_up);
      if(!isWarming){
        hide(el);
        el.textContent = "";
        return;
      }

      const err = (data && (data.init_error || data.error)) ? (data.init_error || data.error) : null;

      // remaining_seconds は /init/status を見て補完する（なければ表示しない）
      const remaining = (data && typeof data.remaining_seconds === "number") ? data.remaining_seconds : null;

      if(err){
        el.textContent = `初期化に失敗しました：${err}（ログをご確認ください）`;
        show(el);
        return;
      }

      if(remaining !== null){
        const m = Math.ceil(remaining / 60);
        el.textContent = `インデックス準備中です（warming_up中です）。推定あと約 ${m} 分です。`;
      }else{
        el.textContent = "インデックス準備中です（warming_up中です）。しばらくして再検索してください。";
      }
      show(el);
    }


    async function fetchInitStatus(){
      try{
        const r = await fetch("/init/status");
        if(!r.ok) return null;
        return await r.json();
      }catch(e){
        return null;
      }
    }

async function fetchPaged(url){
      const r = await fetch(url);
      if(!r.ok){
        return { items: [], has_more: false, offset: 0, limit: PAGE_SIZE, total_visible: 0 };
      }
      return r.json();
    }

    // ===== Lightbox =====
    function openModal({title, bodyHtml}){
      if($("modalTitle")) $("modalTitle").textContent = title || "";
      if($("modalBody")) $("modalBody").innerHTML = bodyHtml || "";
      if($("modalOverlay")) $("modalOverlay").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      if($("modalOverlay")) $("modalOverlay").classList.add("hidden");
      if($("modalBody")) $("modalBody").innerHTML = "";
      document.body.style.overflow = "";
    }

    if($("modalClose")) $("modalClose").addEventListener("click", (e)=>{ e.stopPropagation(); closeModal(); });
    if($("modalOverlay")) $("modalOverlay").addEventListener("click", ()=> closeModal());
    if($("modalBox")) $("modalBox").addEventListener("click", (e)=> e.stopPropagation());
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape"){ closeModal(); } });

    function getYouTubeId(url){
      try{
        const u = new URL(url);
        const v = u.searchParams.get("v");
        if(v) return v;
        if(u.hostname.includes("youtu.be")){
          return u.pathname.replace("/","").trim();
        }
        const m = u.pathname.match(/\/embed\/([^\/]+)/);
        if(m) return m[1];
      }catch(e){}
      return null;
    }

    // ===== FAQ Rendering (タイトル一覧 → クリックでモーダル) =====
    function renderFaq(items, meta){
      const root = $("faqResults");
      if(!root) return;
      root.innerHTML = "";
      if($("faqCount")) $("faqCount").textContent = String(meta.total_visible ?? (items?.length || 0));

      if(!items || items.length === 0){
        root.innerHTML = `<p class="muted">FAQの該当結果はありません。</p>`;
        setPager("faq", false, faqOffset, 0);
        return;
      }

      for(const f of items){
        const title = f.question || "";
        const metaLine = [
          f.id ? `ID: ${esc(f.id)}` : "",
          f.category ? `カテゴリ: ${esc(f.category)}` : "",
          (Array.isArray(f.keywords) && f.keywords.length) ? `KW: ${esc(f.keywords.join(", "))}` : ""
        ].filter(Boolean).join(" / ");

        const steps = Array.isArray(f.steps) ? f.steps : [];
        const stepsHtml = steps.length
          ? `<ol>${steps.map(s => `<li>${esc(s)}</li>`).join("")}</ol>`
          : `<p class="muted">（手順がありません）</p>`;

        const card = document.createElement("div");
        card.className = "faq-title-only";
        card.innerHTML = `<div class="title">${esc(title)}</div>`;
        card.addEventListener("click", ()=>{
          openModal({
            title: title,
            bodyHtml: `
              ${metaLine ? `<div class="muted" style="margin-bottom:10px;">${metaLine}</div>` : ""}
              ${stepsHtml}
            `
          });
        });

        root.appendChild(card);
      }

      setPager("faq", !!meta.has_more, faqOffset, items.length);
    }

    // ===== Video Rendering (カードクリック → モーダル再生) =====
    function renderVideos(items, meta){
      const root = $("videoResults");
      if(!root) return;
      root.innerHTML = "";
      if($("videoCount")) $("videoCount").textContent = String(meta.total_visible ?? (items?.length || 0));

      if(!items || items.length === 0){
        root.innerHTML = `<p class="muted">動画の該当結果はありません。</p>`;
        setPager("video", false, videoOffset, 0);
        return;
      }

      for(const v of items){
        const url = v.url || "#";
        const title = v.title || "";
        const desc = v.description || "";
        const thumb = v.thumbnail || "";

        const card = document.createElement("div");
        card.className = "video-card";
        card.innerHTML = `
          <div class="video-row">
            ${thumb ? `<img class="video-thumb" src="${esc(thumb)}" alt="thumbnail">` : ""}
            <div style="flex:1;">
              <div class="video-title">${esc(title)}</div>
              <div class="muted">${esc(desc)}</div>
            </div>
          </div>
        `;

        card.addEventListener("click", ()=>{
          const vid = getYouTubeId(url);
          const embed = vid ? `https://www.youtube.com/embed/${vid}?autoplay=1` : url;
          openModal({
            title: title,
            bodyHtml: `
              <iframe src="${esc(embed)}"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>
            `
          });
        });

        root.appendChild(card);
      }

      setPager("video", !!meta.has_more, videoOffset, items.length);
    }

    async function loadFaqPage(){
      const q = (lastQuery || "").trim();
      if(!q){
        renderFaq([], {has_more:false, total_visible:0});
        return;
      }
      const url = `/faq/search?query=${encodeURIComponent(q)}&offset=${faqOffset}&limit=${PAGE_SIZE}&paged=1`;
      const data = await fetchPaged(url);
      if(data && data.warming_up){
        const st = await fetchInitStatus();
        if(st){ data.remaining_seconds = st.remaining_seconds; data.init_error = st.error; }
      }
      setWarming('faq', data);
      renderFaq(data.items || [], {has_more: data.has_more, total_visible: data.total_visible});
    }

    async function loadVideoPage(){
      const q = (lastQuery || "").trim();
      if(!q){
        renderVideos([], {has_more:false, total_visible:0});
        return;
      }
      const url = `/search?query=${encodeURIComponent(q)}&offset=${videoOffset}&limit=${PAGE_SIZE}&paged=1`;
      const data = await fetchPaged(url);
      if(data && data.warming_up){
        const st = await fetchInitStatus();
        if(st){ data.remaining_seconds = st.remaining_seconds; data.init_error = st.error; }
      }
      setWarming('video', data);
      renderVideos(data.items || [], {has_more: data.has_more, total_visible: data.total_visible});
    }

    async function doSearch(query){
      lastQuery = (query ?? "").toString().trim();
      faqOffset = 0;
      videoOffset = 0;

      if(!lastQuery){
        if($("faqResults")) $("faqResults").innerHTML = "";
        if($("videoResults")) $("videoResults").innerHTML = "";
        if($("faqCount")) $("faqCount").textContent = "0";
        if($("videoCount")) $("videoCount").textContent = "0";
        setWarming("faq", null);
        setWarming("video", null);
        setPager("faq", false, 0, 0);
        setPager("video", false, 0, 0);
        return;
      }

      await Promise.allSettled([loadFaqPage(), loadVideoPage()]);
    }

    if($("faqPrev")) $("faqPrev").addEventListener("click", async ()=>{ faqOffset = Math.max(0, faqOffset - PAGE_SIZE); await loadFaqPage(); });
    if($("faqNext")) $("faqNext").addEventListener("click", async ()=>{ faqOffset = faqOffset + PAGE_SIZE; await loadFaqPage(); });
    if($("videoPrev")) $("videoPrev").addEventListener("click", async ()=>{ videoOffset = Math.max(0, videoOffset - PAGE_SIZE); await loadVideoPage(); });
    if($("videoNext")) $("videoNext").addEventListener("click", async ()=>{ videoOffset = videoOffset + PAGE_SIZE; await loadVideoPage(); });

    if($("searchInput")){
      $("searchInput").addEventListener("input", ()=>{
        clearTimeout(timer);
        timer = setTimeout(()=> doSearch($("searchInput").value), 250);
      });
      $("searchInput").addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ e.preventDefault(); } });
    }

    // 初期状態
    setPager("faq", false, 0, 0);
    setPager("video", false, 0, 0);
});
</script>

  <!-- Lightbox (Modal) -->
  <div id="modalOverlay" class="lightbox-overlay hidden" role="dialog" aria-modal="true" aria-label="video modal">
    <div class="lightbox" id="modalBox" role="document">
      <div class="lightbox-topbar">
        <div class="lightbox-title" id="modalTitle"></div>
        <div class="lightbox-actions">
<button id="modalClose" class="lightbox-btn primary" aria-label="close">閉じる</button>
        </div>
      </div>
      <div class="lightbox-body" id="modalBody"></div>
    </div>
  </div>

</body>
</html>
