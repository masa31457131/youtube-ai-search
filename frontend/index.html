<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Êù±„É¨ACS „Çµ„Éù„Éº„ÉàÊ§úÁ¥¢</title>
  <style>
    :root {
      --brand: #0066cc;
      --brand-dark: #004fa3;
      --brand-light: #e8f0fb;
      --text: #1a1a2e;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --bg: #f7f9fc;
      --white: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 40px rgba(0,0,0,0.18);
      --radius: 10px;
      --radius-sm: 6px;
      --transition: all 0.22s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Meiryo", "Yu Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
    }

    /* ========== HEADER ========== */
    header {
      background: var(--white);
      border-bottom: 3px solid var(--brand);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
    }

    .header-logo img {
      height: 32px;
      width: auto;
    }

    .header-logo-text {
      font-size: 16px;
      font-weight: 700;
      color: var(--brand);
      white-space: nowrap;
    }

    .header-logo-sub {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      font-weight: 400;
    }

    /* ========== HERO SEARCH ========== */
    .hero {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      padding: 32px 24px 28px;
      text-align: center;
    }

    .hero-title {
      color: var(--white);
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }

    .hero-sub {
      color: rgba(255,255,255,0.78);
      font-size: 13px;
      margin-bottom: 20px;
    }

    .search-wrap {
      max-width: 680px;
      margin: 0 auto;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 14px 52px 14px 18px;
      font-size: 16px;
      border: none;
      border-radius: 28px;
      outline: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      font-family: inherit;
      transition: var(--transition);
      -webkit-appearance: none;
    }

    .search-input:focus {
      box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 3px rgba(255,255,255,0.3);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      font-size: 18px;
    }

    .search-clear {
      position: absolute;
      right: 46px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 18px;
      padding: 4px;
      display: none;
      line-height: 1;
    }

    /* ========== MAIN CONTENT ========== */
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 24px 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .empty-state-desc { font-size: 14px; line-height: 1.7; }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--brand);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-count {
      font-size: 12px;
      font-weight: 600;
      background: var(--brand-light);
      color: var(--brand);
      padding: 2px 8px;
      border-radius: 12px;
    }

    /* ========== FAQ CARDS ========== */
    .faq-list { display: flex; flex-direction: column; gap: 8px; }

    .faq-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .faq-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--brand);
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }

    .faq-card:hover {
      border-color: var(--brand);
      box-shadow: var(--shadow-md);
      transform: translateX(2px);
    }

    .faq-card:hover::before { transform: scaleY(1); }

    .faq-card:active { transform: scale(0.98); }

    .faq-category {
      font-size: 11px;
      font-weight: 600;
      color: var(--brand);
      background: var(--brand-light);
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
      margin-bottom: 6px;
    }

    .faq-question {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      line-height: 1.5;
    }

    /* ========== VIDEO CARDS ========== */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .video-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition);
    }

    .video-card:hover {
      border-color: var(--brand);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .video-card:active { transform: scale(0.97); }

    .video-thumb-wrap {
      position: relative;
      padding-top: 56.25%;
      background: #000;
      overflow: hidden;
    }

    .video-thumb {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .video-card:hover .video-thumb { transform: scale(1.04); }

    .video-play-btn {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 40px; height: 40px;
      background: rgba(255,255,255,0.92);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .video-card:hover .video-play-btn { opacity: 1; }

    .video-info { padding: 8px 10px; }

    .video-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* ========== PAGINATION ========== */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 8px;
    }

    .btn-page {
      padding: 7px 14px;
      border: 1px solid var(--border);
      background: var(--white);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      color: var(--brand);
      cursor: pointer;
      transition: var(--transition);
      font-family: inherit;
    }

    .btn-page:hover:not(:disabled) {
      background: var(--brand);
      color: var(--white);
      border-color: var(--brand);
    }

    .btn-page:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .page-info {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    /* ========== LOADING ========== */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      display: inline-block;
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== LIGHTBOX ========== */
    .lightbox-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 30, 0.7);
      z-index: 1000;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 20px 16px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      backdrop-filter: blur(4px);
    }

    .lightbox-overlay.active { display: flex; }

    .lightbox-box {
      background: var(--white);
      border-radius: var(--radius);
      width: 100%;
      max-width: 700px;
      margin: auto;
      position: relative;
      box-shadow: var(--shadow-lg);
      animation: modalIn 0.25s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: translateY(16px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .lightbox-close {
      position: absolute;
      top: 14px; right: 14px;
      width: 32px; height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: var(--transition);
      z-index: 2;
    }

    .lightbox-close:hover { background: var(--border); color: var(--text); }

    /* FAQ Lightbox */
    .lb-faq-header {
      padding: 24px 24px 16px;
      border-bottom: 1px solid var(--border);
    }

    .lb-category {
      font-size: 11px;
      font-weight: 700;
      color: var(--brand);
      background: var(--brand-light);
      padding: 3px 10px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 10px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .lb-question {
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.5;
      padding-right: 32px;
    }

    .lb-faq-body { padding: 20px 24px 24px; }

    .lb-steps-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 14px;
    }

    .lb-steps {
      list-style: none;
      counter-reset: step;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .lb-steps li {
      counter-increment: step;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .lb-steps li::before {
      content: counter(step);
      flex-shrink: 0;
      width: 26px; height: 26px;
      background: var(--brand);
      color: var(--white);
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lb-steps li span {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      padding-top: 3px;
    }

    .lb-keywords {
      margin-top: 18px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .lb-keyword {
      font-size: 11px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 3px 10px;
      border-radius: 12px;
    }

    /* Video Lightbox */
    .lb-video-header {
      padding: 18px 24px 14px;
      border-bottom: 1px solid var(--border);
    }

    .lb-video-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.4;
      padding-right: 32px;
    }

    .lb-video-body { padding: 0 0 0; }

    .lb-video-iframe-wrap {
      position: relative;
      padding-top: 56.25%;
      background: #000;
    }

    .lb-video-iframe-wrap iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: none;
    }

    .lb-video-desc {
      padding: 16px 24px 24px;
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.7;
    }

    /* ========== FOOTER ========== */
    footer {
      background: #1a1a2e;
      color: rgba(255,255,255,0.6);
      text-align: center;
      padding: 16px 24px;
      font-size: 12px;
    }

    /* ========== MOBILE ========== */
    @media (max-width: 768px) {
      header { padding: 0 14px; height: 52px; }
      .header-logo-text { font-size: 13px; }
      .header-logo-sub { display: none; }

      .hero { padding: 22px 16px 18px; }
      .hero-title { font-size: 17px; }
      .hero-sub { font-size: 12px; margin-bottom: 14px; }
      .search-input { font-size: 15px; padding: 12px 46px 12px 16px; }

      main { padding: 16px 12px; }

      .results-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .video-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .section-title { font-size: 14px; }

      .lightbox-overlay { padding: 10px 8px; align-items: flex-start; }
      .lightbox-box { border-radius: 12px; }
      .lb-faq-header { padding: 18px 18px 14px; }
      .lb-question { font-size: 15px; }
      .lb-faq-body { padding: 16px 18px 20px; }
      .lb-video-header { padding: 14px 18px 12px; }
      .lb-video-title { font-size: 14px; }
      .lb-video-desc { padding: 12px 18px 18px; font-size: 12px; }
    }

    @media (max-width: 400px) {
      .video-grid { grid-template-columns: 1fr 1fr; }
    }

    /* ========== NO RESULT ========== */
    .no-result {
      text-align: center;
      padding: 30px 16px;
      color: var(--text-muted);
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-logo">
      <span style="font-size:26px;">üè¢</span>
      <div>
        <span class="header-logo-text">Êù±„É¨ACS</span>
        <span class="header-logo-sub">„Çµ„Éù„Éº„ÉàÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</span>
      </div>
    </div>
  </header>

  <!-- HERO + SEARCH -->
  <div class="hero">
    <h1 class="hero-title">„Çµ„Éù„Éº„ÉàÊ§úÁ¥¢</h1>
    <p class="hero-sub">FAQ„Éª„Çµ„Éù„Éº„ÉàÂãïÁîª„Çí„Åæ„Å®„ÇÅ„Å¶Ê§úÁ¥¢„Åß„Åç„Åæ„Åô</p>
    <div class="search-wrap">
      <input
        type="search"
        id="searchInput"
        class="search-input"
        placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ... (‰æã: „Éë„Çπ„ÉØ„Éº„Éâ, Ëµ∑Âãï, Âç∞Âà∑)"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      />
      <button id="searchClear" class="search-clear" aria-label="„ÇØ„É™„Ç¢">√ó</button>
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <!-- MAIN -->
  <main id="mainContent">
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">üí°</div>
      <div class="empty-state-title">„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
      <div class="empty-state-desc">
        FAQÔºà„Çà„Åè„ÅÇ„ÇãË≥™ÂïèÔºâ„Å®„Çµ„Éù„Éº„ÉàÂãïÁîª„ÇíÂêåÊôÇ„Å´Ê§úÁ¥¢„Åó„Åæ„Åô„ÄÇ<br>
        Êìç‰ΩúÊñπÊ≥ï„Éª„Éà„É©„Éñ„É´ÂØæÂøú„Å™„Å©„ÄÅÊ∞ó„Å´„Å™„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•„Çå„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ
      </div>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div>
      <div>Ê§úÁ¥¢‰∏≠...</div>
    </div>

    <div id="resultsArea" style="display:none;">
      <div class="results-grid">

        <!-- FAQ ÁµêÊûú -->
        <div>
          <div class="section-title">
            üìã FAQ
            <span class="section-count" id="faqCount">0‰ª∂</span>
          </div>
          <div class="faq-list" id="faqList"></div>
          <div class="pagination" id="faqPagination" style="display:none;">
            <button class="btn-page" id="faqPrev" onclick="changePage('faq', -1)">‚óÄ Ââç„Å∏</button>
            <span class="page-info" id="faqPageInfo"></span>
            <button class="btn-page" id="faqNext" onclick="changePage('faq', 1)">Ê¨°„Å∏ ‚ñ∂</button>
          </div>
        </div>

        <!-- ÂãïÁîª ÁµêÊûú -->
        <div>
          <div class="section-title">
            üé¨ „Çµ„Éù„Éº„ÉàÂãïÁîª
            <span class="section-count" id="vidCount">0‰ª∂</span>
          </div>
          <div class="video-grid" id="videoGrid"></div>
          <div class="pagination" id="vidPagination" style="display:none;">
            <button class="btn-page" id="vidPrev" onclick="changePage('vid', -1)">‚óÄ Ââç„Å∏</button>
            <span class="page-info" id="vidPageInfo"></span>
            <button class="btn-page" id="vidNext" onclick="changePage('vid', 1)">Ê¨°„Å∏ ‚ñ∂</button>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- FAQ Lightbox -->
  <div class="lightbox-overlay" id="faqLightbox">
    <div class="lightbox-box" id="faqLightboxBox">
      <button class="lightbox-close" id="faqLbClose">‚úï</button>
      <div class="lb-faq-header">
        <div class="lb-category" id="lbCategory"></div>
        <div class="lb-question" id="lbQuestion"></div>
      </div>
      <div class="lb-faq-body">
        <div class="lb-steps-label">‚úÖ ÊâãÈ†Ü</div>
        <ol class="lb-steps" id="lbSteps"></ol>
        <div class="lb-keywords" id="lbKeywords"></div>
      </div>
    </div>
  </div>

  <!-- Video Lightbox -->
  <div class="lightbox-overlay" id="vidLightbox">
    <div class="lightbox-box" id="vidLightboxBox">
      <button class="lightbox-close" id="vidLbClose">‚úï</button>
      <div class="lb-video-header">
        <div class="lb-video-title" id="lbVideoTitle"></div>
      </div>
      <div class="lb-video-body">
        <div class="lb-video-iframe-wrap" id="lbIframeWrap"></div>
        <div class="lb-video-desc" id="lbVideoDesc"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    Copyright ¬© 2026 Toray Advanced Computer Solution, Inc.
  </footer>

  <script>
  // ================================================================
  // Áä∂ÊÖãÁÆ°ÁêÜ
  // ================================================================
  var PAGE_SIZE = 9;
  var lastQuery = '';
  var debounceTimer = null;
  var synonyms = {};

  var faqState = { offset: 0, items: [], total: 0 };
  var vidState = { offset: 0, items: [], total: 0 };

  // ================================================================
  // ÂàùÊúüÂåñ
  // ================================================================
  (function init() {
    // ÂêåÁæ©Ë™ûËæûÊõ∏„ÇíÂèñÂæó
    fetch('/api/synonyms')
      .then(function(r) { return r.json(); })
      .then(function(data) { synonyms = data || {}; })
      .catch(function() { synonyms = {}; });

    // Ê§úÁ¥¢ÂÖ•Âäõ„ÅÆ„Ç§„Éô„É≥„Éà
    var input = document.getElementById('searchInput');
    var clearBtn = document.getElementById('searchClear');

    input.addEventListener('input', function() {
      var val = input.value.trim();
      clearBtn.style.display = val ? 'block' : 'none';

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() {
        doSearch(val);
      }, 300);
    });

    clearBtn.addEventListener('click', function() {
      input.value = '';
      clearBtn.style.display = 'none';
      showEmpty();
      input.focus();
    });

    // LightboxÈñâ„Åò„Çã
    document.getElementById('faqLbClose').addEventListener('click', closeFaqLb);
    document.getElementById('vidLbClose').addEventListener('click', closeVidLb);

    document.getElementById('faqLightbox').addEventListener('click', function(e) {
      if (e.target === this) closeFaqLb();
    });
    document.getElementById('vidLightbox').addEventListener('click', function(e) {
      if (e.target === this) closeVidLb();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') { closeFaqLb(); closeVidLb(); }
    });
  })();

  // ================================================================
  // ÂêåÁæ©Ë™ûÂ±ïÈñãÔºàÊ§úÁ¥¢Á≤æÂ∫¶Âêë‰∏äÔºâ
  // ================================================================
  function expandQuery(q) {
    if (!q || !synonyms) return q;
    var terms = [q];
    var qLower = q.toLowerCase();
    Object.keys(synonyms).forEach(function(term) {
      var syns = synonyms[term];
      if (!Array.isArray(syns)) return;
      if (qLower.indexOf(term.toLowerCase()) !== -1) {
        syns.forEach(function(s) {
          if (terms.indexOf(s) === -1) terms.push(s);
        });
      }
      syns.forEach(function(s) {
        if (qLower.indexOf(s.toLowerCase()) !== -1) {
          if (terms.indexOf(term) === -1) terms.push(term);
        }
      });
    });
    return terms.join(' ');
  }

  // ================================================================
  // Ê§úÁ¥¢ÂÆüË°å
  // ================================================================
  function doSearch(q) {
    if (!q) { showEmpty(); return; }
    if (q === lastQuery) return;
    lastQuery = q;

    faqState = { offset: 0, items: [], total: 0 };
    vidState = { offset: 0, items: [], total: 0 };

    showLoading();

    var expanded = expandQuery(q);

    var faqPromise = fetch('/faq/search?query=' + encodeURIComponent(expanded) + '&offset=0&limit=50&paged=1')
      .then(function(r) { return r.json(); })
      .catch(function() { return { items: [], total_visible: 0 }; });

    var vidPromise = fetch('/search?query=' + encodeURIComponent(expanded) + '&offset=0&limit=50&paged=1')
      .then(function(r) { return r.json(); })
      .catch(function() { return { items: [], total_visible: 0 }; });

    Promise.all([faqPromise, vidPromise]).then(function(results) {
      var faqRes = results[0];
      var vidRes = results[1];

      faqState.items = faqRes.items || [];
      faqState.total = faqRes.total_visible || faqState.items.length;

      vidState.items = vidRes.items || [];
      vidState.total = vidRes.total_visible || vidState.items.length;

      renderResults();
    });
  }

  // ================================================================
  // ÊèèÁîª
  // ================================================================
  function renderResults() {
    showResults();
    renderFaq();
    renderVideos();
  }

  function renderFaq() {
    var list = document.getElementById('faqList');
    var countEl = document.getElementById('faqCount');
    var pagination = document.getElementById('faqPagination');
    var total = faqState.total;

    countEl.textContent = total + '‰ª∂';

    var start = faqState.offset;
    var end = Math.min(start + PAGE_SIZE, faqState.items.length);
    var pageItems = faqState.items.slice(start, end);

    if (pageItems.length === 0) {
      list.innerHTML = '<div class="no-result">Ë©≤ÂΩì„Åô„ÇãFAQ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
      pagination.style.display = 'none';
      return;
    }

    list.innerHTML = '';
    pageItems.forEach(function(item, i) {
      var card = document.createElement('div');
      card.className = 'faq-card';
      card.innerHTML =
        '<div class="faq-category">' + esc(item.category || '„Åù„ÅÆ‰ªñ') + '</div>' +
        '<div class="faq-question">' + esc(item.question || '') + '</div>';
      card.addEventListener('click', function() { openFaqLb(item); logClick(lastQuery, 'faq', item.id); });
      list.appendChild(card);
    });

    // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
    var totalPages = Math.ceil(faqState.items.length / PAGE_SIZE);
    var currentPage = Math.floor(faqState.offset / PAGE_SIZE) + 1;

    if (totalPages > 1) {
      pagination.style.display = 'flex';
      document.getElementById('faqPrev').disabled = faqState.offset === 0;
      document.getElementById('faqNext').disabled = end >= faqState.items.length;
      document.getElementById('faqPageInfo').textContent = currentPage + ' / ' + totalPages + ' „Éö„Éº„Ç∏';
    } else {
      pagination.style.display = 'none';
    }
  }

  function renderVideos() {
    var grid = document.getElementById('videoGrid');
    var countEl = document.getElementById('vidCount');
    var pagination = document.getElementById('vidPagination');
    var total = vidState.total;

    countEl.textContent = total + '‰ª∂';

    var start = vidState.offset;
    var end = Math.min(start + PAGE_SIZE, vidState.items.length);
    var pageItems = vidState.items.slice(start, end);

    if (pageItems.length === 0) {
      grid.innerHTML = '<div class="no-result" style="grid-column:1/-1;">Ë©≤ÂΩì„Åô„ÇãÂãïÁîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
      pagination.style.display = 'none';
      return;
    }

    grid.innerHTML = '';
    pageItems.forEach(function(item) {
      var vid = getVideoId(item);
      var thumb = item.thumbnail || (vid ? 'https://i.ytimg.com/vi/' + vid + '/mqdefault.jpg' : '');

      var card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML =
        '<div class="video-thumb-wrap">' +
          (thumb ? '<img class="video-thumb" src="' + esc(thumb) + '" alt="' + esc(item.title || '') + '" loading="lazy" />' : '<div class="video-thumb" style="background:#333;position:absolute;inset:0;"></div>') +
          '<div class="video-play-btn">‚ñ∂</div>' +
        '</div>' +
        '<div class="video-info"><div class="video-title">' + esc(item.title || '') + '</div></div>';

      card.addEventListener('click', function() { openVidLb(item, vid); logClick(lastQuery, 'video', item.video_id || ''); });
      grid.appendChild(card);
    });

    // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
    var totalPages = Math.ceil(vidState.items.length / PAGE_SIZE);
    var currentPage = Math.floor(vidState.offset / PAGE_SIZE) + 1;

    if (totalPages > 1) {
      pagination.style.display = 'flex';
      document.getElementById('vidPrev').disabled = vidState.offset === 0;
      document.getElementById('vidNext').disabled = end >= vidState.items.length;
      document.getElementById('vidPageInfo').textContent = currentPage + ' / ' + totalPages + ' „Éö„Éº„Ç∏';
    } else {
      pagination.style.display = 'none';
    }
  }

  // ================================================================
  // „Éö„Éº„Ç∏„É≥„Ç∞
  // ================================================================
  function changePage(type, dir) {
    if (type === 'faq') {
      faqState.offset = Math.max(0, faqState.offset + dir * PAGE_SIZE);
      renderFaq();
      document.getElementById('faqList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      vidState.offset = Math.max(0, vidState.offset + dir * PAGE_SIZE);
      renderVideos();
      document.getElementById('videoGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // ================================================================
  // Lightbox - FAQÔºàBug#2‰øÆÊ≠£: steps„ÇíÁï™Âè∑‰ªò„Åç„É™„Çπ„Éà„ÅßË°®Á§∫Ôºâ
  // ================================================================
  function openFaqLb(item) {
    document.getElementById('lbCategory').textContent = item.category || '„Åù„ÅÆ‰ªñ';
    document.getElementById('lbQuestion').textContent = item.question || '';

    // Bug#2‰øÆÊ≠£: answer „Åß„ÅØ„Å™„Åè steps[] „Çí‰ΩøÁî®
    var steps = item.steps || [];
    var stepsEl = document.getElementById('lbSteps');
    stepsEl.innerHTML = '';
    if (steps.length === 0) {
      stepsEl.innerHTML = '<li><span>Ë©≥Á¥∞ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</span></li>';
    } else {
      steps.forEach(function(s) {
        var li = document.createElement('li');
        li.innerHTML = '<span>' + esc(s) + '</span>';
        stepsEl.appendChild(li);
      });
    }

    var kwEl = document.getElementById('lbKeywords');
    var keywords = item.keywords || [];
    kwEl.innerHTML = '';
    if (keywords.length > 0) {
      keywords.forEach(function(kw) {
        if (!kw) return;
        var span = document.createElement('span');
        span.className = 'lb-keyword';
        span.textContent = kw;
        kwEl.appendChild(span);
      });
    }

    document.getElementById('faqLightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeFaqLb() {
    document.getElementById('faqLightbox').classList.remove('active');
    document.body.style.overflow = '';
  }

  // ================================================================
  // Lightbox - ÂãïÁîªÔºàBug#3‰øÆÊ≠£: allowÂ±ûÊÄßËøΩÂä†„ÄÅBug#6: video_idÂèñÂæóÔºâ
  // ================================================================
  function openVidLb(item, vid) {
    document.getElementById('lbVideoTitle').textContent = item.title || '';
    document.getElementById('lbVideoDesc').textContent = item.description || '';

    var wrapEl = document.getElementById('lbIframeWrap');
    wrapEl.innerHTML = '';

    if (vid) {
      var iframe = document.createElement('iframe');
      iframe.src = 'https://www.youtube.com/embed/' + vid + '?autoplay=1&rel=0';
      // Bug#3‰øÆÊ≠£: allowÂ±ûÊÄß„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö
      iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen; picture-in-picture');
      iframe.setAttribute('allowfullscreen', '');
      iframe.setAttribute('frameborder', '0');
      iframe.title = item.title || '';
      wrapEl.appendChild(iframe);
    } else {
      wrapEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#fff;background:#222;padding:40px;text-align:center;">ÂãïÁîªID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
    }

    document.getElementById('vidLightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeVidLb() {
    // Bug#3‰øÆÊ≠£: Èñâ„Åò„Åü„Å®„Åç„Å´iframe„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂãïÁîªÂÅúÊ≠¢
    document.getElementById('lbIframeWrap').innerHTML = '';
    document.getElementById('vidLightbox').classList.remove('active');
    document.body.style.overflow = '';
  }

  // ================================================================
  // Bug#6‰øÆÊ≠£: video_idÂèñÂæóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„ÅçÔºâ
  // ================================================================
  function getVideoId(item) {
    var vid = String(item.video_id || '').trim();
    if (vid) return vid;
    var url = String(item.url || '');
    var m = url.match(/[?&]v=([A-Za-z0-9_-]{11})/);
    if (m) return m[1];
    var m2 = url.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
    if (m2) return m2[1];
    return '';
  }

  // ================================================================
  // „É≠„Ç∞Ë®òÈå≤
  // ================================================================
  function logClick(query, resultType, resultId) {
    fetch('/api/log_search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: query,
        result_type: resultType,
        result_id: resultId,
        timestamp: new Date().toISOString()
      })
    }).catch(function() {});
  }

  // ================================================================
  // UIÁä∂ÊÖãÂàá„ÇäÊõø„Åà
  // ================================================================
  function showEmpty() {
    lastQuery = '';
    document.getElementById('emptyState').style.display = '';
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'none';
  }

  function showLoading() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('loadingState').style.display = '';
    document.getElementById('resultsArea').style.display = 'none';
  }

  function showResults() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsArea').style.display = '';
  }

  // ================================================================
  // „Ç®„Çπ„Ç±„Éº„Éó
  // ================================================================
  function esc(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  </script>

</body>
</html>
